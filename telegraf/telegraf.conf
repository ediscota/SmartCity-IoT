[agent]
  omit_hostname = true
  metric_buffer_limit = 200000
  metric_batch_size = 1000
  flush_interval = "5s"

[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["smartcity/+/+/+"]

  qos = 1
  persistent_session = true
  client_id = "telegraf-smartcity"

  username = "$MQTT_USER"
  password = "$MQTT_PASSWORD"

  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"

  name_override = "smartcity_sensors"

  #needed by regex
  topic_tag = "topic"
  
  #source
  tags = { source = "mqtt" }

[[inputs.file]]
  files = ["${THRESHOLDS_PATH}"]
  data_format = "json"
  name_override = "smartcity_config"

[[processors.regex]]
  namepass = ["smartcity_sensors"]

  # Estrae District
  [[processors.regex.tags]]
    key = "topic"
    pattern = "smartcity/([^/]+)/([^/]+)/([^/]+)"
    replacement = "${1}"
    result_key = "district"

  # Estrae Street
  [[processors.regex.tags]]
    key = "topic"
    pattern = "smartcity/([^/]+)/([^/]+)/([^/]+)"
    replacement = "${2}"
    result_key = "street"

  # Estrae Sensor
  [[processors.regex.tags]]
    key = "topic"
    pattern = "smartcity/([^/]+)/([^/]+)/([^/]+)"
    replacement = "${3}"
    result_key = "sensor"

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "$INFLUX_TOKEN"
  organization = "smartcity-org"
  bucket = "smartcity-bucket"

  #better DB formatting
  tagexclude = ["topic", "source"]